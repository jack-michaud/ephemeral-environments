{"id":"ephemeral-7fr","title":"Claude-integrated ephemeral environments","description":"Give AI agents (Claude Code in remote containers) the development environment capabilities they need to test changes.\n\n## Target Environment\nClaude Code running in a remote container (cloud-based). The agent's container itself becomes the development environment.\n\n## First Principles Problem\nA human developer can:\n- Configure their environment\n- Install and manage dependencies\n- Run services together (docker-compose, databases, etc.)\n- Run tests, linters, builds\n- See output, iterate, fix issues\n\nClaude Code in a container needs the same capabilities.\n\n## Architecture: Hybrid Approach\nClaude's container + remote ephemeral environment connected via secure tunnel.\n\n```\nEphemeral EC2                              Claude's Container\n┌─────────────────────┐                   ┌─────────────────────┐\n│ PostgreSQL:5432     │◄──Cloudflare──────│ cloudflared         │\n│ Redis:6379          │   Tunnel          │ localhost:5432      │\n│ App services        │   (encrypted,     │ localhost:6379      │\n│ docker-compose      │    authed)        │                     │\n└─────────────────────┘                   │ npm/pip/tests run   │\n                                          │ locally             │\n                                          └─────────────────────┘\n```\n\n**Security requirements (non-negotiable):**\n- No public internet exposure of services\n- Mutual auth between Claude and ephemeral environment\n- Encrypted tunnel (Cloudflare Access or similar)\n\n**Validated:** cloudflared works in Claude's container environment.\n\n## What This Enables\n1. Claude spins up ephemeral EC2 with services (DB, Redis, app)\n2. EC2 creates Cloudflare tunnel, returns credentials\n3. Claude runs cloudflared locally to connect\n4. Services appear on localhost - Claude runs tests against them\n5. Claude can trigger rebuild for fresh state\n\n## Core Requirements\n1. Ephemeral environment spins up on-demand (Terraform-defined)\n2. Secure tunnel connects Claude to services\n3. Claude runs tests/commands locally (no latency for test execution)\n4. Easy reset - blow away EC2 and recreate\n\n## Open Questions\n- Tunnel credential handoff mechanism\n- How Claude discovers/reconnects to existing environment\n- Cleanup when Claude session ends\n\n## Non-Goals (for now)\n- Full docker-in-docker in Claude's container\n- Multi-environment orchestration\n","status":"open","priority":1,"issue_type":"epic","owner":"noreply@anthropic.com","created_at":"2026-01-18T05:12:49.181658094Z","created_by":"Claude","updated_at":"2026-01-18T05:55:19.710594544Z"}
{"id":"ephemeral-environments-0lj","title":"E2E test for repo secrets injection","description":"Add E2E test coverage for the repo secrets feature.\n\n## Tasks\n1. Configure test secrets in Terraform for the test repo (ephemeral-envs-test)\n2. Update the test repo to expose a secret value in its API response\n3. Update E2E test to verify the secret was injected correctly\n\n## Test approach\n- Create a test secret via Terraform module\n- Test repo exposes an endpoint that returns the secret value (or hash of it)\n- E2E test hits the endpoint and verifies the expected value","status":"closed","priority":2,"issue_type":"task","owner":"mrmichaud42@gmail.com","created_at":"2026-01-17T20:33:02.808547-05:00","created_by":"jack-michaud","updated_at":"2026-01-17T20:36:15.454475-05:00","closed_at":"2026-01-17T20:36:15.454475-05:00","close_reason":"Closed"}
{"id":"ephemeral-environments-2lv","title":"Test issue for hookify rule","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-17T20:28:18.993209-05:00","updated_at":"2026-01-17T20:28:24.831785-05:00","closed_at":"2026-01-17T20:28:24.831785-05:00","close_reason":"Closed"}
{"id":"ephemeral-environments-4nw","title":"Terraform module for repo secrets registration","description":"Create a Terraform module that allows users to register secrets for their repo.\n\n## Secret Source Types\n1. **Direct values** - Plain key-value pairs (stored in Secrets Manager)\n2. **Secrets Manager references** - ARNs to existing secrets\n3. **SSM Parameter references** - Paths to existing SSM parameters\n\n## Example Usage\n```hcl\nmodule \"my_app_secrets\" {\n  source = \"./modules/ephemeral-repo-secrets\"\n  \n  repo_full_name = \"myorg/myapp\"\n  \n  # Direct values (will be stored in Secrets Manager)\n  secrets = {\n    DATABASE_URL = var.database_url\n    API_KEY      = var.api_key\n  }\n  \n  # Reference existing Secrets Manager secrets\n  secrets_manager_refs = {\n    STRIPE_KEY = \"arn:aws:secretsmanager:us-east-1:123:secret:stripe-prod\"\n  }\n  \n  # Reference existing SSM parameters\n  ssm_refs = {\n    CONFIG_VALUE = \"/myapp/prod/config\"\n  }\n}\n```\n\n## Output\n- Creates a registry entry that the deployer can look up\n- Stores metadata about where each secret comes from","status":"closed","priority":2,"issue_type":"task","owner":"mrmichaud42@gmail.com","created_at":"2026-01-17T20:23:13.769204-05:00","created_by":"jack-michaud","updated_at":"2026-01-17T20:28:39.683344-05:00","closed_at":"2026-01-17T20:28:39.683344-05:00","close_reason":"Closed"}
{"id":"ephemeral-environments-78d","title":"Deployer: fetch and inject repo secrets","description":"Update the deployer Lambda to fetch repo-specific secrets from Secrets Manager and inject them into the environment.\n\n## Changes needed\n- src/deployer/handler.py: Look up secrets at ephemeral/{owner}/{repo}\n- src/deployer/ssm_commands.py: Accept secrets dict, export as env vars\n- Handle missing secrets gracefully (repo may not have any configured)\n\n## Security considerations\n- Secrets visible in SSM command history (existing limitation)\n- Consider using SSM Parameter Store for injection instead","status":"closed","priority":2,"issue_type":"task","owner":"mrmichaud42@gmail.com","created_at":"2026-01-17T20:23:20.463239-05:00","created_by":"jack-michaud","updated_at":"2026-01-17T20:28:39.68469-05:00","closed_at":"2026-01-17T20:28:39.68469-05:00","close_reason":"Closed"}
{"id":"ephemeral-environments-9j1","title":"Security: EC2 instance pulls own secrets via IAM role","description":"Improve security of secrets injection by having the EC2 instance fetch its own secrets rather than passing them via SSM.\n\n## Current approach (less secure)\n- Deployer Lambda fetches secrets\n- Passes them via SSM command (visible in SSM history)\n- Secrets embedded in bash script\n\n## Improved approach\n1. Tag EC2 instance with repo name\n2. EC2 IAM role allows reading secrets for tagged repo only\n3. Startup script on EC2 fetches secrets from Secrets Manager\n4. Secrets set as env vars before docker-compose starts\n\n## Implementation\n- Update Packer AMI build to include secrets-fetching script\n- Update EC2 instance profile/role with scoped permissions\n- Update SSM command to just pass repo name (not secrets)\n- Script reads repo from EC2 tags or env var and fetches matching secrets\n\n## Security benefits\n- Secrets never in SSM command history\n- IAM role scoped to specific repo's secrets\n- Less attack surface\n\n## Testing\n- Run E2E tests: `make test-e2e`\n- Verify secrets are injected correctly into the ephemeral environment\n- Confirm SSM command history does not contain secret values\n","status":"closed","priority":2,"issue_type":"task","owner":"mrmichaud42@gmail.com","created_at":"2026-01-17T20:35:26.003346-05:00","created_by":"jack-michaud","updated_at":"2026-01-17T21:56:48.159623-05:00","closed_at":"2026-01-17T21:56:48.159623-05:00","close_reason":"Implementation complete and verified. E2E tests passing with per-repo IAM role, fetch-secrets.sh on AMI, secrets fetched via IAM instead of SSM embedding."}
{"id":"ephemeral-environments-frt","title":"Support .ephemeral/config.yml for secret references","description":"Allow repos to define which secrets they need via a config file.\n\n## Config format\n```yaml\n# .ephemeral/config.yml\nsecrets:\n  - DATABASE_URL\n  - API_KEY\n  - STRIPE_SECRET_KEY\n```\n\n## Behavior\n- Deployer reads config after initial clone\n- Looks up each secret name at ephemeral/{owner}/{repo}/{name}\n- Injects found secrets as environment variables\n- Warns (doesn't fail) if a secret is listed but not found","status":"tombstone","priority":2,"issue_type":"task","owner":"mrmichaud42@gmail.com","created_at":"2026-01-17T20:23:27.552706-05:00","created_by":"jack-michaud","updated_at":"2026-01-17T20:32:53.94759-05:00","close_reason":"Closed","deleted_at":"2026-01-17T20:32:53.94759-05:00","deleted_by":"jack-michaud","delete_reason":"delete","original_type":"task"}
{"id":"ephemeral-environments-l2i","title":"Per-repo secrets support for ephemeral environments","description":"Allow users to specify application secrets that get injected into ephemeral environments.\n\n## Requirements\n- Multiple configuration methods (Terraform, config file, etc.)\n- Secrets stored securely in AWS Secrets Manager\n- Injected as environment variables into docker-compose\n\n## Acceptance Criteria\n- [ ] Secrets can be configured via Terraform module\n- [ ] Secrets can be configured via repo config file\n- [ ] Deployer injects secrets into environment\n- [ ] Documentation updated","status":"closed","priority":2,"issue_type":"task","owner":"mrmichaud42@gmail.com","created_at":"2026-01-17T20:23:06.380321-05:00","created_by":"jack-michaud","updated_at":"2026-01-17T20:58:44.476755-05:00","closed_at":"2026-01-17T20:58:44.476755-05:00","close_reason":"Closed","dependencies":[{"issue_id":"ephemeral-environments-l2i","depends_on_id":"ephemeral-environments-4nw","type":"blocks","created_at":"2026-01-17T20:23:32.514765-05:00","created_by":"jack-michaud"},{"issue_id":"ephemeral-environments-l2i","depends_on_id":"ephemeral-environments-78d","type":"blocks","created_at":"2026-01-17T20:23:32.599951-05:00","created_by":"jack-michaud"},{"issue_id":"ephemeral-environments-l2i","depends_on_id":"ephemeral-environments-0lj","type":"blocks","created_at":"2026-01-17T20:33:07.489581-05:00","created_by":"jack-michaud"}]}
{"id":"ephemeral-environments-owy","title":"E2E: Test Secrets Manager and SSM Parameter Store secret references","description":"Currently E2E tests only verify cleartext secrets are injected. We need to test that secret references (Secrets Manager ARNs, SSM Parameter Store paths) are resolved and injected correctly.\n\n## Requirements\n1. Add test secrets to AWS:\n   - A Secrets Manager secret with a test value\n   - An SSM Parameter Store parameter (SecureString) with a test value\n\n2. Update test repo (`jack-michaud/ephemeral-envs-test`):\n   - Add env vars to docker-compose that reference these secrets\n   - Expose the resolved values via the health endpoint\n\n3. Update Terraform (`infra/aws/test-repo-secrets.tf`):\n   - Register the new secret references in the repo secrets manifest\n\n4. Update E2E tests:\n   - Verify Secrets Manager reference resolves correctly\n   - Verify SSM Parameter Store reference resolves correctly\n\n## Testing\n- Deploy all changes and run E2E tests (see CLAUDE.md \"Deploy \u0026 Test Workflow\")\n- Verify both secret types appear with correct values in health endpoint\n","status":"closed","priority":2,"issue_type":"task","owner":"mrmichaud42@gmail.com","created_at":"2026-01-17T21:40:10.777615-05:00","created_by":"jack-michaud","updated_at":"2026-01-17T22:11:04.263018-05:00","closed_at":"2026-01-17T22:11:04.263018-05:00","close_reason":"Closed"}
